---
title: "BST210_DataCleaning"
date: "2022-10-04"
output: html_document
---

```{r pressure, echo=FALSE}
library(rstudioapi)
library(tidyverse)
library(gam)
library(splines)
library(splines2)  
library(dplyr)
library(tidyr)
library(broom)
library(dslabs)
library(ggplot2)
library(ggthemes)
library(ggrepel)
```

#### Choosing target group
Clean CDI data
Choose target group to be "women aged 18-44 years" for age and gender restricted data
Crude prevalence
```{r}
#Asthma prevalence among women aged 18-44 years
dat_asthma <- read.csv("CDI_Asthma.csv") |> filter(QuestionID=="AST1_2")
#drop missing values for crude rate
#####dat_asthma <- drop_na(dat_asthma, DataValue)
#sort dataframe by year
#####dat_asthma <- dat_asthma[order(dat_asthma$YearStart, decreasing = FALSE),]

#Current cigarette smoking among women aged 18-44 years - Crude Prevalence
dat_smk <- read.csv("CDI_Tobacco.csv")|> filter(QuestionID == "TOB1_3")
dat_smk <- dat_smk[order(dat_smk$YearStart, decreasing = FALSE),]

#Heavy drinking among women aged 18-44 years: QuestionID = ALC5_2
dat_heavyDrink <- read.csv("CDI_Alcohol.csv") |> filter(QuestionID == "ALC5_2")
#Binge drinking prevalence among women aged 18-44 years: QuestionID = ALC2_3
dat_bingeDrink <- read.csv("CDI_Alcohol.csv") |> filter(QuestionID == "ALC2_3")

#Obesity data: Overweight or obesity among women aged 18-44 years - Crude Prevalence
dat_obe <- read.csv("CDI_Obesity.csv")|> filter(QuestionID == "NPAW2_3")

#High school completion among women aged 18-44 years: OVC2_2
dat_highSch <- read.csv("CDI_Overarching.csv")|> filter(QuestionID == "OVC2_2")
#Self-rated health status among women aged 18-44 years: OVC6_2
dat_selfHlthSta <- read.csv("CDI_Overarching.csv")|> filter(QuestionID == "OVC6_2")
#Current health care coverage among women aged 18-44 years: OVC1_2
dat_HlthCare <- read.csv("CDI_Overarching.csv")|> filter(QuestionID == "OVC1_2")
```



Clean Daily Summary data to obtain annual average by state from 2011 to 2019 (Ozone, SO2, CO, NO2)
```{r}
#exposure variables defined as percentage of AQI days with co, no2, o3, pm2.5, pm10 as primary pollutants
# naming pattern: Ozone (44201)	SO2 (42401)	CO (42101)	NO2 (42602) PM2.5 FRM/FEM Mass (88101)


#read in daily summary file - O3
file_o3 <- list.files(path = "./exposure_data", pattern="daily_44201", full.names =T)
dat_o3_tibble <- lapply(file_o3, read.csv)

#read in files of land area of U.S. counties
# LND110210D Land area in square miles 2010
land_area <- readxl::read_xls("LND01.xls") %>% select(Areaname, STCOU, LND110210D) %>% 
  mutate(State.Code = substr(STCOU, start = 1, stop = 2),
         County.Code = substr(STCOU, start = 3, stop = 5)) %>% subset(County.Code != "000") %>% 
  rename(land.area = LND110210D) %>% select(State.Code, County.Code, land.area)

land_area$State.Code <-  gsub("(?<![0-9])0+", "", land_area$State.Code, perl = TRUE) %>% as.integer()
land_area$County.Code <- gsub("(?<![0-9])0+", "", land_area$County.Code, perl = TRUE) %>% as.integer()


#create function to find the annual average of ozone exposure by state
find.state.annual.o3 <- function(x) {
  annual.mean <- x %>% group_by(State.Code, County.Code) %>% mutate(o3 = mean(Arithmetic.Mean)) %>% 
    left_join(land_area, by = c("State.Code", "County.Code")) %>% ungroup() %>% 
    group_by(State.Code) %>% summarise(o3_mean = weighted.mean(o3, land.area))

  return(annual.mean)
}

dat_o3 <- lapply(dat_o3_tibble, find.state.annual.o3)



file_pm2.5 <- list.files(path = "./exposure_data", pattern="daily_88101", full.names =T)
````
